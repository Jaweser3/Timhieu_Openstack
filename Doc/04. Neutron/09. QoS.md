# Quality of Service (QoS) - Neutron

## 1. Giới thiệu

QoS được định nghĩa là khả năng đảm bảo các yêu cấu mạng nhất định như bandwidth, latency (độ trễ), jitter (độ giật) và reliability (độ tin cậy) để đáp ứng Thảo thuần về level của service (Service Level Agreement - SLA) giữa các nhà cũng cấp ứng dụng và end users.

Các thiết bị mạng như switches và routers có thể đánh dấu các traffic để nó được xử lý với priority cao hơn để đáp ứng các điều kiện đã thỏa thuận theo SLA. Trong trường hợp, các lưu lượng mạng nhất định như Voice over IP (VoIP) và video streaming cần được truyền với băng thông được hạn chế tối thiểu. Trên một hệ thống không có network QoS management, tất cả các trafic sẽ được truyền đi theo các nô lực nhất "best-efort" mà không thể đảm bảo được dịch vụ của khách hàng được chuyển đi.

QoS sẽ thể hiện rõ tác dụng ở những vị trí thường xảy ra hiện tượng bottleneck (nút thắt cổ chai), đồng thời quyết định trafic nào có độ ưu tiên cao hơn để quyết định thứ tự truyền đi. 

Trong môi trường Storage: Storage QoS cho phép admin có thể monitor và quản lý và thiết lập rule ưu tiên theo từng kiểu acces và resource sử dụng trong một Storage Cluster. Các policy giúp giới hạn các I/O storage và các VM đảm bảo không vượt qua ngưỡng cho phép.

QoS là một plug-in dịch vụ nâng cao. QoS được tách ra từ phần còn lại của Openstack Network code  ở nhiều levels và nó có thể thông qua trình driver mở rộng ml2.

## 2. QoS trong Neutron

Trong Neutron hiện đang hỗ trợ các rule QoS sau:

* banwitth_limit: hỗ trợ giới hạn băng thông tối đa trên từng network, port và IP floating
* dhcp_marking: hỗ trợ giới hạn băng thông dựa trên DSCP value. - Với QoS. Marking là 1 task nhỏ trong Classtifycation, (và tất nhiên marking lúc này là DSCP cho Difserv). Classtifycation có 2 task là identify gói tin và marking gói tin. sau đó đẩy vào các queuing. dùng scheduling để quyết định gói nào VIP ra trước, gói nào dân đen thì "chờ đi mày". )
* minimum_bandwidth: giới hạn băng thông tối đa dựa lên kiểu kết nối.

Bảng dưới đây là một số các backends, QoS rules được hỗ trợ và các hướng đi của trafic (nhìn từ VM)

<img src="../../img/70.png">


## 3. Configuration

Để enable service, làm theo các bước dưới đây:

### 3.1 Trên Network nodes

Add QoS service vào `service_plugin` trong file `/etc/neutron/neutron.conf`, ví dụ:

```sh
[DEFAULT]
service_plugins = \
neutron.services.l3_router.l3_router_plugin.L3RouterPlugin,
neutron.services.metering.metering_plugin.MeteringPlugin,
neutron.services.qos.qos_plugin.QoSPlugin
```

Sửa file `/etc/neutron/plugins/ml2/ml2_conf.ini`

```sh
[ml2]
extension_drivers = port_security,qos
```

Nếu Open vSwitch agent được sử dụng, sửa file `/etc/neutron/plugins/ml2/openvswitch_agent.ini`

```sh
[agent]
extensions = qos
```

### 3.2 Trên compute node

Sửa file `/etc/neutron/plugins/ml2/openvswitch_agent.ini`

```sh
[agent]
extensions = qos
```

### 3.3 Cấu hình policy.json đáng tin cậy cho project

Nếu các dự ám được tin cậy để quản trị các chính sách QoS của chính chúng trong môi trường cloud của bạn, thì file `policy.json` của neutron sẽ được chỉnh sửa để cho phép điều đó.

Chỉnh sửa file `/etc/neutron/policy.json` 

```sh
"get_policy": "rule:regular_user",
"create_policy": "rule:regular_user",
"update_policy": "rule:regular_user",
"delete_policy": "rule:regular_user",
"get_rule_type": "rule:regular_user",
```

Để enable bandwidth giới hạn các rule:

```sh
"get_policy_bandwidth_limit_rule": "rule:regular_user",
"create_policy_bandwidth_limit_rule": "rule:regular_user",
"delete_policy_bandwidth_limit_rule": "rule:regular_user",
"update_policy_bandwidth_limit_rule": "rule:regular_user",
```

Để enable DSCP đánh dấu rule:

```sh
"get_policy_dscp_marking_rule": "rule:regular_user",
"create_dscp_marking_rule": "rule:regular_user",
"delete_dscp_marking_rule": "rule:regular_user",
"update_dscp_marking_rule": "rule:regular_user",
```

Để enable giá trị tối thiểu của banwidth rule:

```sh
"get_policy_minimum_bandwidth_rule": "rule:regular_user",
"create_policy_minimum_bandwidth_rule": "rule:regular_user",
"delete_policy_minimum_bandwidth_rule": "rule:regular_user",
"update_policy_minimum_bandwidth_rule": "rule:regular_user",
```

## 4. User workflow 

QoS policies chỉ được tạp ra bởi admin với file policy.json mặc định. Vì vậy, bạn nên yêu cầu người điều hành cloud thiết lập chúng thay mặt cho các cloud projects.

Nếu project được tin tưởng để tạp ra chính policies của chúng thì kiểm tra trusted projects policy.json configuration section.

Đầu tiên tạo một QoS policy và các rule giới hạn băng thông của chúng.

```sh
[root@trang-40-71 ~(keystone)]# openstack network qos policy create bw-limiter
+-------------+--------------------------------------+
| Field       | Value                                |
+-------------+--------------------------------------+
| description |                                      |
| id          | a150479c-2501-441e-b61e-15df4daf6b8a |
| is_default  | False                                |
| name        | bw-limiter                           |
| project_id  | 82ee8def450e47b29451b57b094addc8     |
| rules       | []                                   |
| shared      | False                                |
| tags        | []                                   |
+-------------+--------------------------------------+

[root@trang-40-71 ~(keystone)]# openstack network qos rule create --type bandwidth-limit --max-kbps 3000 \
>     --max-burst-kbits 300 --egress bw-limiter
+----------------+--------------------------------------+
| Field          | Value                                |
+----------------+--------------------------------------+
| direction      | egress                               |
| id             | f34dccc7-045e-46bf-9bd8-4dd2c8b7d737 |
| max_burst_kbps | 300                                  |
| max_kbps       | 3000                                 |
| name           | None                                 |
| project_id     |                                      |
+----------------+--------------------------------------+

[root@trang-40-71 ~(keystone)]# openstack network qos rule list bw-limiter
+--------------------+--------------------------------------+-----------------+----------+-----------------+----------+-----------+-----------+
| ID                 | QoS Policy ID                        | Type            | Max Kbps | Max Burst Kbits | Min Kbps | DSCP mark | Direction |
+--------------------+--------------------------------------+-----------------+----------+-----------------+----------+-----------+-----------+
| f34dccc7-045e-46bf-| a150479c-2501-441e-b61e-15df4daf6b8a | bandwidth_limit |     3000 |             300 |          |           | egress    |
+--------------------+--------------------------------------+-----------------+----------+-----------------+----------+-----------+-----------+
```

**Note** : QOS yêu cầu chỉ số burst để chắc chắn sự đúng đắncác các rule set bandwith trên các OpenvSwitch và Linux Bridge. Nếu không set trong quá trình đặt rule thì mặc định chỉ số này sẽ về 80% bandwidth của các gói TCP thông thường. Nếu giá trị burst quá thấp sẽ gây ra việc giảm băng thông so với thông số cấu hình

Các QoS policy có thể được gắn vào port hoặc network cụ thể:

```sh
[root@trang-40-71 ~(keystone)]# openstack port list
+---------------+------+-------------------+-------------------------------------------------------------------------------+--------+
| ID            | Name | MAC Address       | Fixed IP Addresses                                                            | Status |
+---------------+------+-------------------+-------------------------------------------------------------------------------+--------+
| 01e7ee7b-98b6-|      | fa:16:3e:54:93:88 | ip_address='192.168.40.121', subnet_id='f3ae12dc-bbfd-402b-b5e1-bd3917538e25' | ACTIVE |
| 335a7fdf-fa1c-|      | fa:16:3e:95:1a:af | ip_address='10.10.10.13', subnet_id='01524e15-805c-4ceb-8073-0e93781502d2'    | ACTIVE |
|               |      |                   | ip_address='10.10.10.19', subnet_id='01524e15-805c-4ceb-8073-0e93781502d2'    |        |
| 5f88fc7a-dd35-|      | fa:16:3e:d5:42:cf | ip_address='10.10.10.2', subnet_id='01524e15-805c-4ceb-8073-0e93781502d2'     | ACTIVE |
+---------------+------+-------------------+-------------------------------------------------------------------------------+--------+

[root@trang-40-71 ~(keystone)]# openstack port set --qos-policy bw-limiter 335a7fdf-fa1c-47ff-a33a-4625ca759f11

[root@trang-40-71 ~(keystone)]# openstack port show 335a7fdf-fa1c-47ff-a33a-4625ca759f11
+-----------------------+----------------------------------------------------------------------------+
| Field                 | Value                                                                      |
+-----------------------+----------------------------------------------------------------------------+
| admin_state_up        | UP                                                                         |
| allowed_address_pairs |                                                                            |
| binding_host_id       | trang-40-73                                                                |
| binding_profile       |                                                                            |
| binding_vif_details   | datapath_type='system', ovs_hybrid_plug='False', port_filter='True'        |
| binding_vif_type      | ovs                                                                        |
| binding_vnic_type     | normal                                                                     |
| created_at            | 2019-03-07T02:31:16Z                                                       |
| data_plane_status     | None                                                                       |
| description           |                                                                            |
| device_id             | db2ff7bd-4264-4a27-8d64-982a19bb3c78                                       |
| device_owner          | compute:nova                                                               |
| dns_assignment        | None                                                                       |
| dns_domain            | None                                                                       |
| dns_name              | None                                                                       |
| extra_dhcp_opts       |                                                                            |
| fixed_ips             | ip_address='10.10.10.13', subnet_id='01524e15-805c-4ceb-8073-0e93781502d2' |
|                       | ip_address='10.10.10.19', subnet_id='01524e15-805c-4ceb-8073-0e93781502d2' |
| id                    | 335a7fdf-fa1c-47ff-a33a-4625ca759f11                                       |
| mac_address           | fa:16:3e:95:1a:af                                                          |
| name                  |                                                                            |
| network_id            | fa212d72-7d59-4887-bf26-4a34ecf0858c                                       |
| port_security_enabled | True                                                                       |
| project_id            | 82ee8def450e47b29451b57b094addc8                                           |
| qos_policy_id         | a150479c-2501-441e-b61e-15df4daf6b8a                                       |
| revision_number       | 15                                                                         |
| security_group_ids    | e2db2ee9-8864-41d6-bed4-05dd1e1a9cea                                       |
| status                | ACTIVE                                                                     |
| tags                  |                                                                            |
| trunk_details         | None                                                                       |
| updated_at            | 2019-03-08T10:38:07Z                                                       |
+-----------------------+----------------------------------------------------------------------------+
```

Để detach a port from the QoS policy attached vào nó:

```sh
$ openstack port create --qos-policy bw-limiter --network private port1
```



## Tham khảo thêm

[1] https://docs.openstack.org/neutron/pike/admin/config-qos.html


